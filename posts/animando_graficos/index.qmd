---
title: "Animando gr치ficos con gganimate"
author: "Checho"
date: "05/22/2024"
categories: [fun, ggplot2, proyectos]
format: 
  html:
    code-fold: show
    code-summary: "Ver c칩digo"
    code-copy: hover
knitr: 
  opts_chunk: 
    warning: false
    message: false
editor: visual
---

# Dale a tu gr치fico alegr칤a Macarena

Hace rato que no hac칤a boludeces, as칤 que mientras pensaba un fin de semana qu칠 pod칤a hacer, Boca jugaba un nuevo partido en el cual empez칩 perdiendo y termin칩 ganando, y me d칤 cuenta que nunca hab칤a usado el paquete `gganimate` para animar una visualizaci칩n, as칤 que qu칠 mejor que usar un partido de Boca para transmitir las sensaciones del partido a trav칠s de un gr치fico animado.

# gganimate

Para este caso, vamos a necesitar los siguientes paquetes:

```{r}
#| warning: false
#| message: false

library(readxl)     # Leer archivos de excel
library(tidyverse)  # Procesar los datos
library(ggplot2)    # Hacer gr치ficos
library(gganimate)  # A lo que vinimos, a animar los gr치ficos

```

## Bocaaa, Bocaaaa, Bocaaaaaa... 游눛游눝游눛

Desde que Diego Martinez, el actual DT de Boca, asumi칩 su cargo en Diciembre de 2023, una de las caracter칤sticas que tiene su gesti칩n (adem치s de jugar mejor), es que varios partidos los comenz칩 perdiendo, y termin칩 ganando. Al d칤a de hoy, (22 de mayo de 2024), **gan칩 12 partidos, de los cuales en 5 el primer gol lo hizo el rival**.

As칤 que qu칠 mejor ejemplo para graficar este caso de uso que aprovechando el vendaval de sensaciones que es mirar un partido de Boca Jrs. en la era Martinez.

En la fecha 2 del torneo local, Boca enfrent칩 como visitante a Central C칩rdoba de Santiago del Estero, que **convirtieron el primer gol a los 3' de comenzado el partido**, y luego hicieron el 2-0 en el tiempo a침adido al final del primer tiempo.

Apenas comenz칩 el 2춿 tiempo, Equi Fernandez hizo el 2-1, la Bestia Merentiel lo empat칩 y lo di칩 vuelta a los 52' y 80' respectivamente. Cuando el partido estaba en tiempo a침adido, Equi Fernandez puso el 2-4 final.

Acomp치침enme a experimentar el vendaval de sensaciones que es vivir un partido de Boca en un gr치fico.

Vamos a usar el siguiente dataset:

```{r}
#| label: boca-data

# Carga de datos
boca <- read_excel("boca_vibes.xlsx")

# Explora las primeras 6 filas
head(boca)
```

El dataset contiene un detalle de los resultados minuto a minuto, podemos observar el primer gol de Central C칩rdoba convertido por Rodrigo Uriel Atencio a los 3 minutos que deja a Boca abajo en el marcador.

Para hacer el primer gr치fico necesitamos transformar un poco los datos para que los goles de `central_cordoba` y de `boca` nos queden en una misma columna.

```{r}
#| label: data_transformation

partido <- boca |> 
  pivot_longer(cols = c(central_cordoba, boca), 
               names_to = "equipo", 
               values_to = "goles") |> 
  mutate(equipo = str_replace(equipo, "central_cordoba", "Central C칩rdoba"),
         equipo = str_replace(equipo, "boca", "Boca Jrs."))

# Ver c칩mo qued칩 el dataset
head(partido)
```

Usemos un gr치fico de l칤neas para visualizar el partido.

```{r}
#| label: boca grafico base

 ggplot(partido) +                                           # Datos
  geom_line(aes(x = minuto, y = goles, color = equipo),      # Tipo de gr치fico y variables
            linewidth = 1.1) +                               # Ancho de la l칤nea
  scale_color_manual(values = c("#103f79", "#EA0838")) +     # Colores custom
  theme_minimal() +                                          # Estilo del gr치fico
  labs(title = "Central C칩rdoba vs. Boca",
       x = "Goles", y = "Minuto",
       color = "Equipo")
```

Le podemos incorporar una l칤nea adicional para visualizar c칩mo iba el partido para Boca, en el cual podemos apreciar c칩mo arranca perdiendo, cerca del minuto '50 lo empata, y en el final lo da vuelta.

```{r}
#| label: primer grafico


# Guardamos el gr치fico en un objeto llamado 'p'
p <-  ggplot(partido) +                                           # Datos
  geom_line(aes(x = minuto, y = goles, color = equipo),      # Tipo de gr치fico y variables
            linewidth = 1.1) +                               # Ancho de la l칤nea
  scale_color_manual(values = c("#103f79", "#EA0838")) +         # Colores custom
  theme_minimal() +                                          # Estilo del gr치fico
  labs(title = "Central C칩rdoba vs. Boca",
       x = "Minuto", y = "Goles",
       color = "Equipo") +
  geom_line(data = boca, aes(x = minuto, y = diferencia), linewidth = 1.3,
            linetype = 2)

# Veamos el gr치fico
p
```

Pero venimos a ver un gr치fico animado, as칤 que demosle movimiento al gr치fico.

```{r}
#| label: boca primera animacion

# Animemos el gr치fico
# transition_reveal funciona con gr치ficos de l칤neas
p + 
  transition_reveal(along = minuto) # MAGIA!!!!
```

Y manipulando un poco los datos podemos hacer cosas gloriosas...

```{r}
#| label: boca_full_experience
#| warning: false
#| message: false

# A침adir una columna para agregar un emoji en funci칩n de la diferencia y los goles
boca <- boca |> 
  # Arranca el partido
  mutate(estado = if_else(diferencia == 0 , "meh", if_else( 
  # Primer gol de Central C칩rdoba
    diferencia < 0 & central_cordoba == 1, "cry",  if_else(
  # Segundo gol de Central C칩rdoba
      diferencia < 0 & central_cordoba == 2, "angry", if_else(
  # Primer gol de Boca
        diferencia < 0 & boca == 1, "fear", if_else(
  # Segundo gol de Boca
          diferencia == 1 & boca == 2, "biceps", if_else(
  # Tercer gol de Boca y cuarto gol
            diferencia == 1, "smile", "lol")
          )
        )
      ))))


# Mapear cada nombre de emoji a un emoji
# Link al paquete de emoji: https://github.com/hadley/emo
boca <- boca |> 
  mutate(emoji = map_chr(estado, emo::ji))

# Veamos como quedan los datos
head(boca)

# Hagamos el gr치fico final con anotaciones
p + 
  # A침adimos anotaciones en funci칩n de los goles
  geom_text(data = boca, aes(x = 15, y = 3.5, 
                             label = paste0("Central C칩rdoba: ", central_cordoba,
                                            "\nBoca: ", boca)),
            size = 4,        # Tama침o de la letra
            hjust = 0) +     # Alinea a la izquierda
# A침adimos anotaciones usando emojis
  geom_text(data = boca, aes(x = 15, y = 2.5, label = emoji), 
            size = 15) +
# A침adimos un "subt칤tulo"
  geom_text(data = boca, aes(x = 0, y = 4.5, label = paste0("Resultado: ", resultado)), hjust = 0) +
# Animemos el gr치fico
   transition_reveal(along = minuto)

# Ya que estamos, guardemos el gr치fico en un gif
anim_save("boca_gganimate.gif", animation = last_animation())
```

Si quieren ver c칩mo fue el partido, pueden ver el siguiente resumen. Despu칠s me cuentan qu칠 transmite m치s emoci칩n, si mi gr치fico o el video 游븷

{{< video https://www.youtube.com/watch?v=lVcTxBZfPNg >}}
